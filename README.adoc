= Agrirouter© Middleware
:imagesdir: assets/img
:toc:
:toc-title:
:toclevels: 4

== The Project

image::agrirouter-middleware-logo.png[agrirouter-middleware,175,role=left]

The agrirouter© middleware was developed to have easier access to the functionality of the agrirouter.
The agrirouter© middleware is an additional layer of abstraction and provides access to the agrirouter© without deep knowledge of the underlying processes.
The agrirouter© middleware manages the connections and fetches messages from the agrirouter, based on the technical messages types registered.
In addition, the agrirouter© middleware provides simple data conversion from ISOXML TaskData to EFDI Telemetry Data and provides searching operations for DDIs and other parts of the specification.

== Current Status

image::https://github.com/agrirouter-middleware/agrirouter-middleware/actions/workflows/status_badge.yml/badge.svg[Status badge,link="https://github.com/agrirouter-middleware/agrirouter-middleware/actions/workflows/status_badge.yml"]

== The Partners

The project would not have been possible without strong partners for the idea and the development.
The following companies have taken an active part during the development of the agrirouter© middleware.

image::partners/krone.png[krone,175,role="left]

The initial idea for the agrirouter© middleware has been developed by the https://landmaschinen.krone.de/[Maschinenfabrik Bernard Krone GmbH & Co. KG].
The main concept is based on the idea to make the agrirouter© connection easier for third party app providers.

image::partners/holmer.png[holmer,175,role="left]

The https://www.holmer-maschinenbau.com/[Holmer Maschinenbau GmBH] joined the project after the development started and added the use case of sending machine data using the agrirouter© middleware.
The agrirouter© middleware is part of the communication concept between their machines and the agrirouter© on the other side.

image::partners/lmis.svg[lmis,175,role="left]

The https://lmis.de[LMIS AG] is part of the agrirouter© universe since the beginning of the project and was chosen as implementation partner for the middleware.
Using an agile development process the middleware was developed in 2021/2022 and will be maintained as long as the project is active.

image::partners/agrirouter.svg[lmis,175,role="left]

Without the https://my-agrirouter.com[agrirouter] there would not have been such a project.
The easy way to connect machines, farming software and telemetry platforms is one essential step to a strong network of agricultural machines.

== Want To Try It?

The https://lmis.de[LMIS AG] is providing free hosting of the agrirouter© for development purpose.
All you need to do is to send a request using the https://www.lmis.de/connectivity-service-for-agrirouter/[contact form] on the website.
The hosting on the QA environment is free and won't be charged.
If you need a hosting offer for production, please send out a request as well - there are reasonable packages for everyone.

In addition, the project has an easy-to-use Docker compose script, a rapid solution for local development.

== Public Postman Workspace

There is a public Postman workspace available, which can be used to test the agrirouter© middleware.
The workspace can be found here:

https://www.postman.com/gold-trinity-758038/workspace/agrirouter-middleware

If there are any questions or issues regarding the workspace, please feel free to create an issue in the GitHub repository.
Thanks for your support!

== How Does It Work?

The agrirouter© middleware is an abstraction to the well-known interface of the https://my-agrirouter.com[agrirouter].
The agrirouter© middleware uses the interface of the agrirouter© and provides an easy way to manage applications and endpoints, send and receive messages or handle the connection to the agrirouter.

image::system-overview.svg[agrirouter© middleware overview]

The agrirouter© middleware provides a REST interface for endpoint management, sending messages and retrieving messages.
On the other hand the connection to the agrirouter© is based on the faster MQTT protocol to have live telemetry data with real push notifications.
The messages from the agrirouter© are fetched, confirmed and stored within an internal database.
There is no need to implement the business process on your own.

== Why Should You Use It?

The agrirouter© middleware is ready for certification.
What does this mean?
By using the agrirouter© middleware you are ready to speed up the certification process, since most of the requirements are already fulfilled by the middleware.
To get an overview, please see the following table of https://docs.my-agrirouter.com/agrirouter-interface-documentation/latest/certification.html'[certification criteria]:

[cols="1,1,1"]
|===
|Certification criteria |Status |Comment

|Secured Onboarding
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware covers the whole onboarding process. You only need to integrate a button to call one of the endpoints and add the status checking. After this you are ready to go.

|Authorization
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware ships customizable redirect pages and everything you need to connect to the agrirouter© and pass the certiciation.

|Verfication
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware verifies the response from the agrirouter© and adds that extra bit of security.

|Revoking
a|image::readme/thumb_up.png[ready,25,role="left]
|If the user wants to disconnect the endpoint, the agrirouter© brings all you need to add this functionality.

|Using / Updating router devices
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware is ready to use router devices and provides an easy way to update the router device.

|VCU onboarding / off-boarding
a|image::readme/thumb_up.png[ready,25,role="left]
|Using the agrirouter© middleware to run your telemetry platform you are able to register your machines as virtual endpoints.

|agrirouter© commands
a|image::readme/thumb_up.png[ready,25,role="left]
|Since the agrirouter© middleware is based on the agrirouter© SDKs, all the commands are supported and implemented.

|Chunking
a|image::readme/thumb_up.png[ready,25,role="left]
|Chunking is necessary for all formats that transport "non-telemetry" data (ISOXML, SHAPE, images, videos, ...) and the agrirouter© middleware is capable of it.

|Encoding
a|image::readme/thumb_up.png[ready,25,role="left]
|All messages are encoded correctly, therefore no need to worry.

|Message addressing
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware supports direct addressing as well as publishing of messages.

|Merging chunks
a|image::readme/thumb_up.png[ready,25,role="left]
|All messages are fetched from the agrirouter© and can be downloaded even if they are chunked.

|Push notifications
a|image::readme/thumb_up.png[ready,25,role="left]
|By default, the agrirouter© middleware uses push notifications to receive messages directly from the agrirouter©. If one of the push notifications has been missed, there is a scheduled job to fetch pending messages.

|Clean you feed
a|image::readme/thumb_up.png[ready,25,role="left]
|With the agrirouter© you can rely on a solid mechanism to fetch all messages from the agrirouter©. Nothing will be lost.

|Error handling
a|image::readme/thumb_up.png[ready,25,role="left]
|Errors from the agrirouter© will be transformed into speaking business errors (if necessary).

|===

== Functional documentation

=== How to authenticate the requests?

The endpoints of the middleware are secured by HTTP basic authentication.
You have to use the *ID of the tenant* and the corresponding *access token* to authenticate.

image::documentation/tenant_log_entry.png[logentry]

[IMPORTANT]
.Default tenant generation on startup
====
During the first startup of the middleware, a default tenant is generated and printed on level INFO within the log file.
You have to store the credentials at a safe place to authenticate again.
====

=== How to integrate the middleware in your project?

If you have a running instance, the integration is quite easy.
The following diagram shows the main aspects of the integration process in your personal application.

image::documentation/integration.png[integration]

==== Set up an instance of the middleware

There are two possible options when setting up an instance of the middleware.
The first one is to set up the whole environment by yourself and the second one would be to have a look at a commercial offer, like the https://www.lmis.de/connectivity-service-for-agrirouter/["Connectivity Service for agrirouter©"], which is based on the middleware and provides multiple packages for different needs.

==== Configuration of the callbacks and the certificates within the agrirouter©

If you do not have an agrirouter© account, please follow the instructions to register a developer account and create your application within the agrirouter© to proceed with the integration.
If you already have an application, you can start with the configuration of the application.

First thing to do is the configuration of the callback within the agrirouter©.

image::documentation/configure_callback.png[callback]

The callback endpoint is part of the middleware and has to be reachable as redirect target for the onboard process.

After you configured the callback, you need to generate the certificates.
Both certificates, the public and the private one are needed for the next steps.
So please save them to a keystore, a notepad or something else.

==== Register an application within the middleware

After finishing the configuration within the agrirouter© you are ready to set up your application within the middleware.
There is a dedicated endpoint to register a new application, please see the Swagger documentation of the middleware to have all the details.

==== Define the capabilities of the application

Each application version has its own capabilities and therefore, they have to be configured during the setup process.
An example could be:

[source,json]
----
{
    "supportedTechnicalMessageTypes": [
        {
            "direction": "SEND",
            "technicalMessageType": "ISO_11783_TASKDATA_ZIP"
        },
        {
            "direction": "SEND",
            "technicalMessageType": "SHP_SHAPE_ZIP"
        }
    ]
}
----

In this case the application would be able to send ISO11783 task data and shape files.
If you need more details, please see the Swagger documentation.

Regarding the capabilities, the middleware is able to handle the following technical message types (content message types):

[cols="1,3"]
|===
    |Content Message Type |Matching technical message type within the agrirouter©

    |ISO_11783_TASKDATA_ZIP | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/taskdata.html[iso:11783:-10:taskdata:zip]

    |SHP_SHAPE_ZIP | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/shape.html[shp:shape:zip]

    |DOC_PDF | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/doc.html[doc:pdf]

    |IMG_JPEG | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/image.html[img:jpeg]

    |IMG_PNG | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/image.html[img:png]

    |IMG_BMP | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/image.html[img:bmp]

    |VID_AVI | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/video.html[vid:avi]

    |VID_MP4 | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/video.html[vid:mp4]

    |VID_WMV | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/video.html[vid:wmv]

    |GPS_INFO | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/gps.html[gps:info]

    |ISO_11783_DEVICE_DESCRIPTION | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/efdi.html#iso11783-10device_descriptionprotobuf-teamsetefdi-device-description[iso:11783:-10:device_description:protobuf]

    |ISO_11783_TIME_LOG | https://docs.agrirouter.com/agrirouter-interface-documentation/latest/tmt/efdi.html#iso11783-10time_logprotobuf-efdi-timelog[iso:11783:-10:time_log:protobuf]

|===

==== Onboard process for new endpoints

The middleware provides endpoints for the onboard process for farming software and telemetry platforms, communication units are not supported, since they are not in the main scope of server side software.
The endpoints for the onboard process will redirect the user to the agrirouter© interface.
If you do not define a redirect URL when calling the endpoint, then the redirect will be to a page within the agrirouter middleware.
Otherwise, the priority for redirect urls is as follows:

1. `redirectUrl` parameter within the call of the endpoint
2. `redirectUrl` within the settings of the application (see Swagger documentation for more details)
3. Default redirect page within the middleware

After you created you own endpoint with your chosen `externalEndpointId`, the `externalEndpointId` is everything you need to send data and fetch messages from the agrirouter©.

=== Profiles

There are three main profiles, the `dev` profile, the `qa` profile and the `prod` profile.
The profiles define which log level is set or which job intervals are configured.You can activate those profiles via https://www.baeldung.com/spring-profiles[Spring Boot configuration] on the command line or via environment variable.

In addition, there are two profiles which activate the maintenance mode to access additional REST endpoints = this is the  `maintenance` profile - or enable the access to the PROD environment of the agrirouter© - the profile `connect-agrirouter-prod`.
Those profiles can be set in addition to the main profiles.

==== DEV

`-Dspring.profiles.active=dev`

Running the middleware in DEV mode with access to the QA environment of the agrirouter©.

==== QA

`-Dspring.profiles.active=qa`

Running the middleware in QA mode with access to the QA environment of the agrirouter©.

==== PROD

`-Dspring.profiles.active=prod`

Running the middleware in PROD mode with access to the QA environment of the agrirouter©.

==== Maintenance

`-Dspring.profiles.active=qa,maintenance`

Running the middleware in QA and in maintenance mode with access to the QA environment of the agrirouter©.

==== agrirouter© PROD environment access

`-Dspring.profiles.active=qa,maintenance,connect-agrirouter-prod`

Running the middleware in QA and in maintenance mode with access to the QA environment of the agrirouter©.
This mode injects a production environment with specific URLs for the agrirouter©.

=== Logging

Each of the profiles defines the log level based on SLF4J.
The following information is available:

==== Business operations

Each changing business operation is logged with the log level "TRACE".
The log contains the following information:

* ID of the endpoint (`externalEndpointId` [eid] and `agriroputerEndpointId` [aid]).
* ID of the application (`internalApplicationId` [iid] `applicationId` [aid]).
* Log message for the business operation.

==== Trace of business operations

There is an aspect for business operations that logs with the log level "TRACE".
The log contains the following information:

* Name of the method that is called.
* Parameters and parameter values of the method.
* Execution time of the method.

=== Scheduled jobs

There are several scheduled jobs that are executed in the background.
The following jobs are running:

==== Scheduled connection checking

The middleware checks the connection of each endpoint to the agrirouter© in a configurable intervall.
The following intervall is configured by default:

* No profile: every minute
* 'dev' profile: every minute
* 'qa' profile: every 15 minutes
* 'prod' profile: every 30 minutes

==== Scheduled fetching and confirming messages

The middleware fetches messages from the agrirouter© and confirms them in a configurable intervall.
The following intervall is configured by default:

* No profile: every 5 minutes
* 'dev' profile: every 5 minutes
* 'qa' profile: every 15 minutes
* 'prod' profile: every 15 minutes

==== Scheduled message sending from the cache

The middleware is sending out the cached messages in a configurable intervall.
The following intervall is configured by default:

* No profile: every 5 minutes
* 'dev' profile: every 5 minutes
* 'qa' profile: every 15 minutes
* 'prod' profile: every 30 minutes

==== Scheduled removal of ACKs

If the agrirouter© is not responding, the middleware is caching the messages waiting for ACKs and removes them in a configurable intervall.
The following intervall is configured by default:

* No profile: every 5 minutes
* 'dev' profile: every 5 minutes
* 'qa' profile: once a day
* 'prod' profile: once a day

==== Scheduled recipient query

The recipients of the endpoints are queried in a configurable intervall.
The following intervall is configured by default:

* No profile: every 5 minutes
* 'dev' profile: every 5 minutes
* 'qa' profile: every 15 minutes
* 'prod' profile: every 30 minutes

==== Scheduled status logging

The middleware logs the status of the endpoints in a configurable intervall.
The following intervall is configured by default:

* No profile: every 5 minutes
* 'dev' profile: every 5 minutes
* 'qa' profile: every 15 minutes
* 'prod' profile: every 30 minutes

== Development

=== Swagger

The project provides a Swagger documentation and brings its own Swagger-UI that can be accessed using the following url:

http://your-path-to-the-middleware/swagger-ui/index.html

When running the project locally, the Swagger-UI can be found http://localhost:8080/swagger-ui/index.html[here].

=== Prerequisites for building and running the application

* Java 17
* Maven

=== Setting up the database for local development using `docker-compose`

To have a rapid start into developing, you can use the `docker compose` script located within the `dev` folder.
The script created both of the necessary databases and after this you are ready to start the development.
In addition, there is a run configuration for IDEA with all environment variables set - ready, steady, go!

=== Environment variables

To run the application, the following environment variables have to be set.

|===
|Name |Description

|`MONGODB_HOST` |Host for the MongoDB.
|`MONGODB_PASSWORD` |Password for the MongoDB.
|`MONGODB_PORT` |Port for the MongoDB.
|`MONGODB_SCHEMA` |Schema / Database for the MongoDB.
|`MONGODB_USER` |User for the MongoDB.
|`MYSQL_HOST` |Host for the Maria DB / MySQL.
|`MYSQL_PASSWORD` |Password for the Maria DB / MySQL.
|`MYSQL_PORT` |Port for the Maria DB / MySQL.
|`MYSQL_SCHEMA` |Schema / Database for the Maria DB / MySQL.
|`MYSQL_USER` |User for the Maria DB / MySQL.
|===

=== Authentication for the GitHub packages

To build the project from scratch you need to authenticate for GitHub packages.
Please see the following https://docs.github.com/en/packages/guides/configuring-apache-maven-for-use-with-github-packages[website]
for more details.

=== Run database

Within the `env/database` folder there is a shell script to build and run the database.
Just run `build.sh` to create and run a docker container.

=== Create and run the docker image

Creating the docker image is straight-forward.

* Build and install all the dependencies via `mvn clean install`.
* Run `spring-boot:build-image` to create the docker image within the module `agrirouter-middleware-application`.
* Run `docker run -it -p8080:8080 agrirouter-middleware-application:1.0-SNAPSHOT` to run the container locally.

=== Running the whole stack using docker-compose

You can run the whole required stack, including Mongo and MariaDB, using docker-compose.

* copy `.env.example` to `.env` (or run `./prepare-env.sh`, which sets secure passwords)
* edit `.env`:
* set `GITHUB_USER` and `GITHUB_TOKEN` to credentials from GitHub, the token only needs `read:packages` rights
* set all fields marked as "required" (not needed if `prepare-env` has been used)
* run (one of) the following commands:
* `docker-compose build`: builds the agrirouter-middleware sourcecode and packs it into a docker image
* `docker-compose up [-d]`: creates and starts all containers (agrirouter middleware, mongo and mysql) [in detached mode]
* `docker-compose stop`: stops the running containers
* `docker-compose down [-v]`: removes all containers, but keeps the volumes which hold the data [unless -v is specified]
* `docker-compose logs [-f]`: print the accumulated logs from all containers [and follow the output]

After the initialization of the databases is complete (the middleware container will restart multiple times because the database is not available yet) and all containers are up, you can extract the generated tenant credentials from the logs:

----
docker-compose logs middleware | grep "Generated default" -B 2 -A 8
----

== Releases

The release workflow has switched to a continuous delivery workflow, where every commit will trigger a new release and result in a new artifact.
If there are any manual migrations necessary, the documentation can be found right here.

=== Update your version

==== 2.1.0 to 3.0

There are some breaking changes in release 3.0 and therefore the documentation has been updated.

===== Status codes

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/87[PR 87] there was a change in the way the HTTP status codes are handled.
The response does not contain a real HTTP status code and no longer the literal.
Please see the Swagger documentation for more information.

===== Searching for time logs

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/89[PR 89] there was a change regarding the search of time logs.
The search is now based on the timestamp of the message and searching for an ID is not supported anymore.

The former search query did look like this:

image::documentation/release_3_0/old_search_for_timelogs.png[search for time logs,role="left"]

The new search query looks like this:

image::documentation/release_3_0/new_search_for_timelogs.png[search for time logs,role="left"]

===== Monitoring endpoints

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/103[PR 103] the monitoring for endpoints has been changed.
This is the main reason why this release is a breaking change.
If you did not include the monitoring in any of your tools you can now ignore the rest of this section.

The endpoint "status" has been modified and was replaced by several, more detailed endpoints to lower the amount of data transferred during the monitoring.
The common endpoint "status" is still available, but some details where cut out and moved to specific endpoints.
Please see the updated Swagger documentation for details.

The former endpoint status did look like this:

image::documentation/release_3_0/old_endpoint_status.png[old endpoint status,role="left]

The new endpoint status looks like this:

image::documentation/release_3_0/new_endpoint_status.png[new endpoint status,role="left]

==== 3.0 to 3.1

There are no breaking changes in this release (as the version indicates already).
Although there are some new features for efficiency and performance.

===== Internal status page

With the release 3.1 you can now access the internal status page of the agrirouter© middleware.
You can find all your applications and their belonging endpoints there.
Each of the endpoints has a detailed dashboard, where you can see the current status of the endpoint and the last messages that have been sent or received.
Errors are also displayed there.

image::documentation/release_3_1/endpoint_overview.png[endpoint overview,role="left]

As you can see, there are small icons indicating the current status.
You are able to hover over them and see the details of the status.

image::documentation/release_3_1/endpoint_status_details.png[endpoint status details,role="left]

Each of the endpoints has a dedicated dashboard showing common errors, warnings, virtual endpoints and much more.
The sections are only displayed if there is any data to show.

image::documentation/release_3_1/endpoint_dashboard.png[endpoint dashboard,role="left]

===== New endpoints for the maintenance mode

The maintenance mode has some new endpoints to reset the state of an endpoint, remove an endpoint completely or to remove the whole application.
Please handle with care and only use them if you know what you are doing.
Since the maintenance endpoints are available without any authentication, you should only expose them to internal networks.

image::documentation/release_3_1/new_maintenance_endpoints.png[new maintenance endpoints,role="left]

==== 3.1 to 3.2

No need for special documentation, no breaking or important changes.
Just bugfixes.

==== 3.2 to 4.0

With this release there are breaking changes, so please note the following migration guide.

===== Former `applicationId` is now `internalApplicationId`

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/167[PR 167] the naming was updated.
The name `applicationId` has was misleading, and therefore it has been changed.
The new name is `internalApplicationId`.

image::documentation/release_4_0/former_internal_application_id.png[new usage of the internal application id,role="left]

===== Former `privateKey` and `publicKey` are now `base64EncodedPrivateKey` and `base64EncodedPublicKey`

Since the parameter names did not reflect the actual content, they have been changed.
The new names are `base64EncodedPrivateKey` and `base64EncodedPublicKey` for application registration.
The format is still the same, just the name has been changed.

image::documentation/release_4_0/changed_names_for_private_and_public_key.png[new parameter names for application registration,role="left]

===== Technical message types are now shown in the application details

This is no breaking change, but a new feature. The technical message types are now shown in the application details. This is useful for debugging and monitoring. You can find them either in the response of the application details or in the internal status page.

image::documentation/release_4_0/tmts_in_the_request.png[technical message types,role="left]

image::documentation/release_4_0/tmts_in_internal_status_page.png[technical message types,role="left]

===== Additional features in the internal status page

There are several new features in the internal status page. You can clear error several status messages / error messages and see the pending delivery tokens for the endpoints.

image::documentation/release_4_0/clear_error_messages.png[clear error messages,role="left]

===== Public Postman collection

With the new release there comes a handy Postman collection for the agrirouter© middleware. You find the link right in the documentation.

===== New endpoints for the maintenance mode

The maintenance mode has a new endpoint to reset the password for a tenant. Please handle with care and only use them if you know what you are doing. Since the maintenance endpoints are available without any authentication, you should only expose them to internal networks.

image::documentation/release_4_0/reset_password_for_tenant.png[new maintenance endpoint,role="left]

