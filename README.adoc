= Agrirouter© Middleware
:imagesdir: assets/img
:toc:
:toc-title:
:toclevels: 4

== The Project

image::agrirouter-middleware-logo.png[agrirouter-middleware,175,role=left]

The agrirouter© middleware was developed to have easier access to the functionality of the agrirouter.
The agrirouter© middleware is an additional layer of abstraction and provides access to the agrirouter© without deep knowledge of the underlying processes.
The agrirouter© middleware manages the connections and fetches messages from the agrirouter, based on the technical messages types registered.
In addition, the agrirouter© middleware provides simple data conversion from ISOXML TaskData to EFDI Telemetry Data and provides searching operations for DDIs and other parts of the specification.

== Current Status

image::https://github.com/agrirouter-middleware/agrirouter-middleware/actions/workflows/status_badge.yml/badge.svg[Status badge,link="https://github.com/agrirouter-middleware/agrirouter-middleware/actions/workflows/status_badge.yml"]

== The Partners

The project would not have been possible without strong partners for the idea and the development.
The following companies have taken an active part during the development of the agrirouter© middleware.

image::partners/krone.png[krone,175,role="left]

The initial idea for the agrirouter© middleware has been developed by the https://landmaschinen.krone.de/[Maschinenfabrik Bernard Krone GmbH & Co. KG].
The main concept is based on the idea to make the agrirouter© connection easier for third party app providers.

image::partners/holmer.png[holmer,175,role="left]

The https://www.holmer-maschinenbau.com/[Holmer Maschinenbau GmBH] joined the project after the development started and added the use case of sending machine data using the agrirouter© middleware.
The agrirouter© middleware is part of the communication concept between their machines and the agrirouter© on the other side.

image::partners/lmis.svg[lmis,175,role="left]

The https://lmis.de[LMIS AG] is part of the agrirouter© universe since the beginning of the project and was chosen as implementation partner for the middleware.
Using an agile development process the middleware was developed in 2021/2022 and will be maintained as long as the project is active.

image::partners/agrirouter.svg[lmis,175,role="left]

Without the https://my-agrirouter.com[agrirouter] there would not have been such a project.
The easy way to connect machines, farming software and telemetry platforms is one essential step to a strong network of agricultural machines.

== Functional Documentation

The agrirouter© middleware is documented using the OpenAPI standard, you can find the documentation within the project.
Do you need more than a OpenAPI documentation?
Feel free to have a look at the xref:DOCUMENTATION.adoc[functional documentation].

== Want To Try It?

The https://lmis.de[LMIS AG] is providing free hosting of the agrirouter© for development purpose.
All you need to do is to send a request using the https://www.lmis.de/connectivity-service-for-agrirouter/[contact form] on the website.
The hosting on the QA environment is free and won't be charged.
If you need a hosting offer for production, please send out a request as well - there are reasonable packages for everyone.

In addition, the project has an easy-to-use Docker compose script, a rapid solution for local development.

== How Does It Work?

The agrirouter© middleware is an abstraction to the well-known interface of the https://my-agrirouter.com[agrirouter].
The agrirouter© middleware uses the interface of the agrirouter© and provides an easy way to manage applications and endpoints, send and receive messages or handle the connection to the agrirouter.

image::system-overview.svg[agrirouter© middleware overview]

The agrirouter© middleware provides a REST interface for endpoint management, sending messages and retrieving messages.
On the other hand the connection to the agrirouter© is based on the faster MQTT protocol to have live telemetry data with real push notifications.
The messages from the agrirouter© are fetched, confirmed and stored within an internal database.
There is no need to implement the business process on your own.

== Why Should You Use It?

The agrirouter© middleware is ready for certification.
What does this mean?
By using the agrirouter© middleware you are ready to speed up the certification process, since most of the requirements are already fulfilled by the middleware.
To get an overview, please see the following table of https://docs.my-agrirouter.com/agrirouter-interface-documentation/latest/certification.html'[certification criteria]:

[cols="1,1,1"]
|===
|Certification criteria |Status |Comment

|Secured Onboarding
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware covers the whole onboarding process. You only need to integrate a button to call one of the endpoints and add the status checking. After this you are ready to go.

|Authorization
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware ships customizable redirect pages and everything you need to connect to the agrirouter© and pass the certiciation.

|Verfication
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware verifies the response from the agrirouter© and adds that extra bit of security.

|Revoking
a|image::readme/thumb_up.png[ready,25,role="left]
|If the user wants to disconnect the endpoint, the agrirouter© brings all you need to add this functionality.

|Using / Updating router devices
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware is ready to use router devices and provides an easy way to update the router device.

|VCU onboarding / off-boarding
a|image::readme/thumb_up.png[ready,25,role="left]
|Using the agrirouter© middleware to run your telemetry platform you are able to register your machines as virtual endpoints.

|agrirouter© commands
a|image::readme/thumb_up.png[ready,25,role="left]
|Since the agrirouter© middleware is based on the agrirouter© SDKs, all the commands are supported and implemented.

|Chunking
a|image::readme/thumb_up.png[ready,25,role="left]
|Chunking is necessary for all formats that transport "non-telemetry" data (ISOXML, SHAPE, images, videos, ...) and the agrirouter© middleware is capable of it.

|Encoding
a|image::readme/thumb_up.png[ready,25,role="left]
|All messages are encoded correctly, therefore no need to worry.

|Message addressing
a|image::readme/thumb_up.png[ready,25,role="left]
|The agrirouter© middleware supports direct addressing as well as publishing of messages.

|Merging chunks
a|image::readme/thumb_up.png[ready,25,role="left]
|All messages are fetched from the agrirouter© and can be downloaded even if they are chunked.

|Push notifications
a|image::readme/thumb_up.png[ready,25,role="left]
|By default, the agrirouter© middleware uses push notifications to receive messages directly from the agrirouter©. If one of the push notifications has been missed, there is a scheduled job to fetch pending messages.

|Clean you feed
a|image::readme/thumb_up.png[ready,25,role="left]
|With the agrirouter© you can rely on a solid mechanism to fetch all messages from the agrirouter©. Nothing will be lost.

|Error handling
a|image::readme/thumb_up.png[ready,25,role="left]
|Errors from the agrirouter© will be transformed into speaking business errors (if necessary).

|===

== Release-Management

The release workflow has switched to a continuous delivery workflow, where every commit will trigger a new release and result in a new artifact.
If there are any manual migrations necessary, the documentation can be found right here.

=== Update your version

==== 2.1.0 to 3.0

There are some breaking changes in release 3.0 and therefore the documentation has been updated.

===== Status codes

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/87[PR 87] there was a change in the way the HTTP status codes are handled.
The response does not contain a real HTTP status code and no longer the literal.
Please see the Swagger documentation for more information.

===== Searching for time logs

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/89[PR 89] there was a change regarding the search of time logs.
The search is now based on the timestamp of the message and searching for an ID is not supported anymore.

The former search query did look like this:

image::documentation/release_3_0/old_search_for_timelogs.png[search for time logs,role="left"]

The new search query looks like this:

image::documentation/release_3_0/new_search_for_timelogs.png[search for time logs,role="left"]

===== Monitoring endpoints

With https://github.com/agrirouter-middleware/agrirouter-middleware/pull/103[PR 103] the monitoring for endpoints has been changed.
This is the main reason why this release is a breaking change.
If you did not include the monitoring in any of your tools you can now ignore the rest of this section.

The endpoint "status" has been modified and was replaced by several, more detailed endpoints to lower the amount of data transferred during the monitoring.
The common endpoint "status" is still available, but some details where cut out and moved to specific endpoints.
Please see the updated Swagger documentation for details.

The former endpoint status did look like this:

image::documentation/release_3_0/old_endpoint_status.png[old endpoint status,role="left]

The new endpoint status looks like this:

image::documentation/release_3_0/new_endpoint_status.png[new endpoint status,role="left]

==== 3.0 to 3.1

There are no breaking changes in this release (as the version indicates already). Although there are some new features for efficiency and performance.

===== Internal status page

With the release 3.1 you can now access the internal status page of the agrirouter© middleware. You can find all your applications and their belonging endpoints there. Each of the endpoints has a detailed dashboard, where you can see the current status of the endpoint and the last messages that have been sent or received. Errors are also displayed there.

image::documentation/release_3_1/endpoint_overview.png[endpoint overview,role="left]

As you can see, there are small icons indicating the current status. You are able to hover over them and see the details of the status.

image::documentation/release_3_1/endpoint_status_details.png[endpoint status details,role="left]

Each of the endpoints has a dedicated dashboard showing common errors, warnings, virtual endpoints and much more. The sections are only displayed if there is any data to show.

image::documentation/release_3_1/endpoint_dashboard.png[endpoint dashboard,role="left]

===== New endpoints for the maintenance mode

The maintenance mode has some new endpoints to reset the state of an endpoint, remove an endpoint completely or to remove the whole application. Please handle with care and only use them if you know what you are doing. Since the maintenance endpoints are available without any authentication, you should only expose them to internal networks.

image::documentation/release_3_1/new_maintenance_endpoints.png[new maintenance endpoints,role="left]